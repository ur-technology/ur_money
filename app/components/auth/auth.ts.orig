import {Injectable, Inject, ViewChild} from '@angular/core'
import {Nav} from 'ionic-angular';
<<<<<<< acde71a5178eb6a1617ab1df95a96b82ed150d3e
import {AngularFire, FirebaseRef, FirebaseObjectObservable} from 'angularfire2';
=======
import {AngularFire, FirebaseListObservable, FirebaseObjectObservable} from 'angularfire2'
>>>>>>> some changes
import {Component} from '@angular/core';
import * as lodash from 'lodash';
<<<<<<< acde71a5178eb6a1617ab1df95a96b82ed150d3e
import { Subject } from 'rxjs/Subject';

@Injectable()

export class Auth {
    
    @Inject(FirebaseRef) private ref: Firebase
    public uid: string
    public user: FirebaseObjectObservable<any>;
    public userRef: any
    public phoneVerfificationSubject: Subject<any>;

    // public authDataProfileImage: any
    // public authDataProfileName: any
    // public authDataProfileDescription: any
    // public authDataProfileEmail: any

    constructor(public angularFire: AngularFire) {
=======
import * as Firebase from 'firebase';
import {Subject} from 'rxjs/Subject';
import {Subscription} from 'rxjs';
2
@Injectable()

export class Auth {
  public uid: string
  public userRef: string
  public user: FirebaseObjectObservable<any>;

  // public authDataProfileImage: any
  // public authDataProfileName: any
  // public authDataProfileDescription: any
  // public authDataProfileEmail: any

  constructor(public angularFire: AngularFire) {
  }

  static firebaseUrl() {
    // TODO: this will work only for webapp, not for mobile app -- need to fix this
    if (/ur\.capital$|urcapital-production\.firebaseapp\.com$/.test(window.location.hostname)) {
      return "https://urcapital-production.firebaseio.com/";
    } else {
      return "https://blinding-torch-3730.firebaseio.com/";
>>>>>>> some changes
    }
  }

  firebaseRef() {
    return new Firebase(Auth.firebaseUrl());
  }

  respondToAuth(nav: Nav, authPage: any, unauthPage: any) {
    this.angularFire.auth.subscribe((authData) => {
      if (authData) {
        this.uid = authData.uid;
        this.userRef = `/users/${this.uid}`;
        this.user = this.angularFire.database.object(this.userRef);
        nav.setRoot(authPage);
      } else {
        this.uid = undefined;
        this.user = undefined;
        nav.setRoot(unauthPage);
      }
    });
  }

  requestPhoneVerification(phone: string) {
    let database = this.angularFire.database;
    return new Promise((resolve) => {
      console.log('about to queue verification number');

      var phoneVerificationReference = database.list('/phoneVerifications', { preserveSnapshot: true }).push({
        phone: phone,
        createdAt: Date.parse(new Date().toISOString()) // would like to change this to database.ServerValue.TIMESTAMP
      });
      
      console.log("verification queued");
      phoneVerificationReference.on('value', (snapshot) => {
        console.log(snapshot);
        var phoneVerification = snapshot.val();
        console.log(phoneVerification);
        if (phoneVerification && lodash.isBoolean(phoneVerification.smsSuccess)) {
          console.log("resolving promise");
          phoneVerificationReference.off('value'); // stop watching for changes on this phone verification
          resolve({ phoneVerificationKey: snapshot.key(), smsSuccess: phoneVerification.smsSuccess, smsError: phoneVerification.smsError });
        }
      });
    });
  }

  checkVerificationCode(phoneVerificationKey: string, attemptedVerificationCode: string) {
    return new Promise((resolve) => {
      let phoneVerificationObservable: FirebaseObjectObservable<any> = this.angularFire.database.object(`/phoneVerifications/${phoneVerificationKey}`);
      phoneVerificationObservable.update({ attemptedVerificationCode: attemptedVerificationCode });
      let phoneVerificationSubscription: Subscription = phoneVerificationObservable.subscribe((phoneVerification) => {
        if (phoneVerification && lodash.isBoolean(phoneVerification.smsSuccess)) {
          if (phoneVerification.verificationSuccess) {
            this.angularFire.auth.login({ token: phoneVerification.authToken }, (error, authData) => {
              console.log('Authentication succeded: ' + !error);
              stopWatchingPhoneVerificationAndResolvePromise(!error);
            });
          } else {
            stopWatchingPhoneVerificationAndResolvePromise(false);
          }
        }
      });

      function stopWatchingPhoneVerificationAndResolvePromise(success) {
        phoneVerificationSubscription.unsubscribe();
        if (success) {
          phoneVerificationObservable.remove();
        }
        resolve(success);
      }
    });
  }

  isSignedIn() {
    return !!this.uid;
  }

}
